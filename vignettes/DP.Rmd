---
title: "Dose-Proportionality"
lang: "en"
output:
  rmarkdown::html_vignette:
    css: vignette.css
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{DP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#"
)
```
| [Main Vignette](vignette.html) | [ABE](ABE.html "Average Bioequivalence") | [RSABE](RSABE.html "Reference-scaled Average Bioequivalence") | [Non-Inferiority](NI.html) | <span  style="color:#006400" title="You are here">Dose-Proportionality</span> | [Power Analysis](PA.html) |
|:-:|:-:|:-:|:-:|:-:|:-:|
<div class="top"><a class="toplink" href="#" title="▲ top"> </a></div>
```{r setup}
library(PowerTOST) # attach the library
```

# Defaults
| Parameter | Argument | Purpose | Default |
|-|---|---------------|----|
| $\alpha$ | `alpha` | Nominal level of the test | `0.05` |
| *CV* | `CV` | CV | none |
| doses | `doses` | Vector of doses | see examples |
| $\pi$ | `targetpower` | <span title="typically 0.80 – 0.90">Minimum desired power</span> | `0.80` |
| $\beta_{0}$ | `beta0` | ‘True’ or assumed slope of the power model | see below |
| $\theta_{1}$ | `theta1` | Lower limit for the ratio of dose normalized means *Rdmn* | see below |
| $\theta_{2}$ | `theta2` | Upper limit for the ratio of dose normalized means *Rdmn* | see below |
| design | `design` | Planned design | `"crossover"` |
| dm | `dm` | Design matrix | `NULL` |
| *CV~b~* | `CVb` | Coefficient of variation of the between-subject variability. | – |
| print | `print` | Show information in the console? | `TRUE` |
| details | `details` | Show details of the sample size search? | `FALSE` |
| imax | `imax` | Maximum number of iterations | `100` |

Arguments have to be given as ratios, not percent.\
The *CV* is generally the *within*-subject coefficient of variation. Only for `design="parallel"` it is the *total* (a.k.a. pooled) *CV*. The *between*-subject coefficient of variation *CV~b~* is only neccessary if `design="IBD"` (if missing, it will be set to `2*CV`).

The ‘true’ or assumed slope of the power model <small>$\beta_{0}$</small> defaults to `1+log(0.95)/log(rd)`, where `rd` is the ratio of the highest/lowest dose.

Supported designs are `"crossover"` (default; Latin Squares), `"parallel"`, and `"IBD"` (incomplete block design). Note that instead of Latin Squares any Williams’ design can be used as well (identical degrees of freedom).

With `sampleN.dp(..., details = FALSE, print = FALSE)` results are provided as a data.frame with ten (if `design="crossover"`) or eleven (if `design="parallel"` or `design="IBD"`) columns: `Design`, `alpha`, `CV`, [`CVb`], `doses`, `beta0`, `theta1`, `theta2`, `Sample size`, `Achieved power`, and `Target power`. To access *e.g.*, the sample size use `sampleN.dp[["Sample size"]]`.

The estimated sample size gives always the *total* number of subjects (not subject/sequence in crossovers or subjects/group in parallel designs).

# Examples
Estimate the sample size for a modified Fibonacci dose-escalation study, lowest dose 10, 3 levels. Assumed *CV* 0.20, and <small>$\beta_{0}$</small> slightly higher than 1. Defaults employed.
```{r}
mod.fibo <- function(lowest, levels) {
  # modified Fibonacci dose-escalation
  fib      <- c(2, 1 + 2/3, 1.5, 1 + 1/3)
  doses    <- numeric(levels)
  doses[1] <- lowest
  level    <- 2
  repeat {
    if (level <= 4) {
      doses[level] <- doses[level-1] * fib[level-1]
    } else {  # ratio 1.33 for all higher doses
      doses[level] <- doses[level-1] * fib[4]
    }
    level <- level + 1
    if (level > levels) {
      break
    }
  }
  return(signif(doses, 3))
}
lowest <- 10
levels <- 3
doses  <- mod.fibo(lowest, levels)
sampleN.dp(CV = 0.20, doses = doses, beta0 = 1.02)
```

As above but with an additional level.
```{r}
levels <- 4
doses  <- mod.fibo(lowest, levels)
x <- sampleN.dp(CV = 0.20, doses = doses, beta0 = 1.02) # we need the data.frame later
```
Note that with the wider dose range the acceptance range narrows.

Explore the impact of dropouts.
```{r}
res <- data.frame(n = seq(x[["Sample size"]], 12, -1),
                  power = NA)
for (i in 1:nrow(res)) {
  res$power[i] <- signif(suppressMessages(
                           power.dp(CV = 0.20, doses = doses,
                                    beta0 = 1.02,
                                    n = res$n[i])), 4)
}
res <- res[res$power >= 0.80, ]
print(res, row.names = FALSE)
```
As usual nothing to worry about.

Rather extreme: 5 levels, but we want only 3 periods. Hence, we opt for an incomplete block design. The design matrix is obtained from the library `crossdes`.
```{r}
levels <- 5
doses  <- mod.fibo(lowest, levels)
dm     <- crossdes::des.MOLS(trt = levels, k = 3)
sampleN.dp(CV = 0.20, doses = doses, beta0 = 1.02,
           design = "IBD", dm = dm)
```
The IBD comes with a price since we need at least two blocks.

For a wide dose range the acceptance range becomes increasingly difficult to meet.
```{r}
doses  <- 2^(seq(0, 8, 2))
levels <- length(doses)
dm     <- crossdes::des.MOLS(trt = levels, k = 3)
sampleN.dp(CV = 0.20, doses = doses, beta0 = 1.02,
           design = "IBD", dm = dm)
```
In an exploratory setting more liberal limits could be specified (only one has to be specified; the other is calculated as the reciprocal of it).
```{r}
sampleN.dp(CV = 0.20, doses = doses, beta0 = 1.02,
           design = "IBD", dm = dm, theta1 = 0.75)
```
Hummel *et al*.^[Hummel J, McKendrick S, Brindley C, French R. *Exploratory assessment of dose proportionality: review of current approaches and proposal for a practical criterion.* Pharm. Stat. 2009; 8(1): 38--49. [doi:10.1002/pst.326](https://doi.org/10.1002/pst.326).] proposed even more liberal {<small>$\theta_{1},\theta_{2}$</small>} of {0.50, 2.0}.

# *Cave!*
There is no guarantee that a desired incomplete block design (for given dose levels and number of periods) can be constructed. If you provide your own design matrix (in the argument `dm`) it is not assessed for meaningfulness.

# Author
Detlew Labes

# Man-pages
Man-pages of functions used in this vignette:

  * [sampleN.dp](library/html/sampleN.dp.html)
  * [power.dp](library/html/power.dp.html)

[Online manual](https://cran.r-project.org/package=PowerTOST/PowerTOST.pdf "PDF") of all functions.

# License
[GPL-2](https://cran.r-project.org/web/licenses/GPL-2 "GNU General Public License, Version 2") | [GPL-3](https://cran.r-project.org/web/licenses/GPL-3 "GNU General Public License, Version 3")
