---
title: "Reference-Scaled Average Bioequivalence"
lang: "en"
output:
  rmarkdown::html_vignette:
    css: vignette.css
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{RSABE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#"
)
```
| [Main Vignette](library/doc/vignette.html) | [ABE](library/doc/ABE.html) | <span title="You are here">RSABE</span> | [Non-Inferiority](library/doc/NI.html) | [Dose-Proportionality](library/doc/DP.html) | [Power Analysis](library/doc/PA.html) |
|:-:|:-:|:-:|:-:|:-:|:-:|
```{r setup}
library(PowerTOST) # attach the library
```
# Defaults

| Parameter | Argument | Purpose | Default |
|-|----|--------------|-------|
| $\alpha$ | `alpha` | Nominal level of the test | 0.05 |
| $\pi$ | `targetpower` | <span title="typically 0.80 – 0.90">Minimum desired power</span> | 0.80 |
| $\theta_{0}$ | `theta0` | ‘True’ or assumed T/R ratio | 0.90 |
| $\theta_{1}$ | `theta1` | Lower BE limit and PE constraint | 0.80 |
| $\theta_{2}$ | `theta2` | Upper BE limit and PE constraint | 1.25 |
| *CV* | `CV` | CV | none |
| design | `design` | Planned replicate design | <span title="partial replicate">`"2x3x3"`</span> |
| regulator | `regulator` | ‘target’ jurisdiction | `"EMA"` |
| nsims | `nsims` | Number of simulations | see below |
| nstart | `nstart` | Start if a previous run failed | none |
| imax | `imax` | Maximum number of iterations | 100 |
| print | `print` | Show information in the console? | TRUE |
| details | `details` | Show details of the sample size search? | FALSE |
| setseed | `setseed` | Issue a fixed seed of the random number generator? | TRUE |

Arguments have to be given as ratios, not percent.\
The *CV* is the within-subject coefficient of variation. If one value is given, homoscedasticity (equal variances) is assumed and therefore, *CV~wT~* = *CV~wR~*. If two values are given (*i.e.*, `CV=c(x, y)`) heteroscedasticity (unequal variances) is assumed, and the first value has to be *CV~wT~* and the second *CV~wR~*.  

If simulating for power (`theta0` within the BE limits), `nsims` defaults to 100,000. If simulating for the empiric type I error (`theta0` set to one of the BE limits), `nsims` defaults to 1 million.

<small>[TOC ↩](#TOC)</small>

<h2>Implemented Designs</h2><!-- not in the TOC -->
```{r, echo=FALSE}
cols <- c(2, 9, 3)
print(known.designs()[7:12, cols], row.names = FALSE)
```
With `foo(..., details = FALSE, print = FALSE)` results are given as a data.frame with eleven columns `Design`, `alpha`,  `CVwT`, `CVwR`, `theta0`, `theta1`, `theta2`, `Sample size`, `Achieved power`, `Target power`, and `nlast`. To access *e.g.*, the sample size use either `foo[1, 8]` or `foo[["Sample size"]]`. We suggest to use the latter in your code for clarity.

The estimated sample size gives always the *total* number of subjects (not subject/sequence).

<small>[TOC ↩](#TOC)</small>

<h2>Conditions and Methods</h2><!-- not in the TOC -->

Regulatory conditions and methods of evaluation are different.
```{r, echo=FALSE}
L <- c(sprintf("%.4f", scABEL(CV = 0.5, regulator = "EMA")[["lower"]]),
       sprintf("%.4f", scABEL(CV = 0.57382, regulator = "HC")[["lower"]]),
       "none")
U <- c(sprintf("%.4f", scABEL(CV = 0.5, regulator = "EMA")[["upper"]]),
       sprintf("%.4f", scABEL(CV = 0.57382, regulator = "HC")[["upper"]]),
       "none")
res       <- data.frame(regulator = c("EMA", "HC", "FDA"),
                        CVswitch = 0.30,  CVcap = NA, r_const = NA,
                        L = L, U = U, pe_constr = NA, method = NA,
                        stringsAsFactors = FALSE)
x         <- unlist(reg_const(regulator = "EMA"))
res[1, c(2:4, 7:8)]  <- x[c(2, 4, 3, 5:6)]
x         <- unlist(reg_const(regulator = "HC"))
res[2, c(2:4, 7:8)]  <- x[c(2, 4, 3, 6:5)]
x         <- unlist(reg_const(regulator = "FDA"))
res[3, c(2:4, 7:8)]  <- x[c(2, 4, 3, 6:5)]
res[, 3]  <- sprintf("%.5f", as.numeric(res[, 3]))
res[3, 3] <- "none"
res[, 4]  <- signif(as.numeric(res[, 4]), 5)
print(res, row.names = FALSE)
```
`CVswitch` is the lower cap of scaling, *i.e.*, if *CV~wR~* is below this value reference-scaling is not acceptable. The upper cap of scaling `CVcap` differes between the EMA and HC, whereas for the FDA scaling is unlimited. The regulatory constant `r_const` is used for calculating the expanded limits (EMA, HC) and ‘implied limits’ (FDA) based on *s~wR~*: <small>$\left[ {L,U} \right] = 100{e^{ \mp 0.760 \cdot {s_{wR}}}}$</small>\
Here `L` and `U` give the maximum acceptable expansion based on <small>$s^*_{wR}=\sqrt{log({CVcap}^2+1)}$</small>. The point estimate constraint `pe_constr` [0.80, 1.25] is applicable in all regulations. Evaluation has to be performed by ANOVA (EMA) or a mixed-effects model (HC, FDA). For the latter intra-subject contrasts are a suffiently close approximation.
 
<small>[TOC ↩](#TOC)</small>

# Sample Size
## Highly Variable Drugs / Drug Products
Estimate the sample size for assumed intra-subject *CV* 0.55 (*CV~wT~* = *CV~wR~*). Employ the defaults (`theta0=0.90`, `targetpower=0.80`, `design="2x3x3"`, `nsims=1e5`).

### EMA
Average Bioequivalence with Expanding Limits (ABEL). Default `regulator="EMA"`.\
Note that this approach is recommended in other jurisdictions as well (*e.g.*, the WHO; ASEAN States, Australia, Brazil, the East African Community, Egypt, the Eurasian Economic Union, New Zealand, the Russian Federation).
```{r}
sampleN.scABEL(CV = 0.55)
```
<small>[TOC ↩](#TOC)</small>

<h2>Heterogenicity</h2><!-- not in the TOC -->

Whilst in full replicate designs simulating via the ‘key’ statistics closely matches the ‘gold standard’ of subject simulations, this is less so for unequal variances in the partial replicate design. Let us keep *CV~w~* 0.55 and split variances by ratio of 1.5 (*i.e.*, T has a higher variance than R).
```{r}
CV <- signif(CVp2CV(CV = 0.55, ratio = 1.5), 4)
sampleN.scABEL(CV = CV, details = FALSE)
```
Although the runtime will be longer, we recommend the function `sampleN.scABEL.sdsims()` instead.
```{r}
CV <- signif(CVp2CV(CV = 0.55, ratio = 1.5), 4)
sampleN.scABEL.sdsims(CV = CV, details = FALSE)
```
The sample size is slightly larger.

<small>[TOC ↩](#TOC)</small>

### Health Canada
Average Bioequivalence with Expanding Limits (ABEL). Defaults as above but `regulator="HC"`.
```{r}
sampleN.scABEL(CV = 0.55, regulator = "HC")
```
<small>[TOC ↩](#TOC)</small>

### FDA
Apart from the FDA only required by China’s agency.
```{r}
sampleN.RSABE(CV = 0.55)
```
Note the lower sample size compared to the other approaches (due to the different regulatory constant and unlimited scaling).

<small>[TOC ↩](#TOC)</small>

## Narrow Therapeutic Index Drugs (FDA)
Assuming heteroscedasticity (*CV~w~* 0.125, *σ*^2^ ratio 2.5, *i.e.*, T has a substantially higher variability than R). Employ the defaults (`theta0=0.975`, `targetpower=0.80`, `design="2x2x4"`, `nsims=1e5`). Details of the sample size search suppressed. Assess additionally which one of the three components (scaled, ABE, *s~wT~*/*s~wR~* ratio) drives the sample size.
```{r}
CV <- signif(CVp2CV(CV = 0.125, ratio = 2.5), 4)
n  <- sampleN.NTIDFDA(CV = CV, details = FALSE)[["Sample size"]]
suppressMessages(power.NTIDFDA(CV = CV, n = n, details = TRUE))
```
The *s~wT~*/*s~wR~* component shows the lowest power and hence, drives the sample size.  
Compare that with homoscedasticity (*CV~wT~* = *CV~wR~* = 0.125):
```{r}
CV <- 0.125
n  <- sampleN.NTIDFDA(CV = CV, details = FALSE)[["Sample size"]]
suppressMessages(power.NTIDFDA(CV = CV, n = n, details = TRUE))
```    
Here the scaled ABE component shows the lowest power and drives the sample size, which is much lower than in the previous example.

<small>[TOC ↩](#TOC)</small>

## Highly Variable Narrow Therapeutic Index Drugs (FDA)
Almost a contradiction in itself. Required for [dagibatran](https://www.accessdata.fda.gov/drugsatfda_docs/psg/Dabigatran%20etexilate%20mesylate_oral%20capsule_NDA%20022512_RV05-17.pdf "Recommended Jun 2012; Revised Sep 2015, Jul 2017") and [rivaroxaban](https://www.accessdata.fda.gov/drugsatfda_docs/psg/Rivaroxaban_oral%20tablet_22406_RC09-15.pdf "Recommended Sep 2015").\
Assuming homoscedasticity (*CV~wT~* = *CV~wR~* = 0.30). Employ the defaults (`theta0=0.95`, `targetpower=0.80`, <span style="white-space:nowrap">`design="2x2x4"`</span>, `nsims=1e5`). Details of the sample size search suppressed.
```{r}
sampleN.HVNTID(CV = 0.30, details = FALSE)
```
Assuming heteroscedasticity (*CV~w~* 0.30, *σ*^2^ ratio 2.5).
```{r}
CV <- signif(CVp2CV(CV = 0.125, ratio = 2.5), 4)
sampleN.HVNTID(CV = CV, details = FALSE)
```
In this case a substantially higher sample size is required since the variability of T is higher than the one of R.

<small>[TOC ↩](#TOC)</small>

# Power
Power can by calculated by the counterparts of the respective sample size functions (instead the argument `targetpower` use the argument `n` and provide the observed `theta0`), *i.e.*,\
`power.scABEL()`, `power.RSABE()`, `power.NTIDFDA()`, and `power.HVNTID()`.  

# Type I Error

Wonnemann *et al.*^[Wonnemann M, Frömke C, Koch A. *Inflation of the Type I Error: Investigations on Regulatory Recommendations for Bioequivalence of Highly Variable Drugs.* Pharm Res. 2015: 32(1); 135--43. [doi:10.1007/s11095-014-1450-z](https://doi.org/10.1007/s11095-014-1450-z).], Muñoz *et al.*^[Muñoz J, Alcaide D, Ocaña J. *Consumer’s risk in the EMA and FDA regulatory approaches for bioequivalence in highly variable drugs.* Stat Med. 2016: 35(12); 1933--43. [doi:10.1002/sim.6834](https://doi.org/10.1002/sim.6834).],
Labes and Schütz^[Labes D, Schütz H. *Inflation of Type I Error in the Evaluation of Scaled Average Bioequivalence, and a Method for its Control.* Pharm Res. 2016: 33(11); 2805--14. [doi:10.1007/s11095-016-2006-1](https://doi.org/10.1007/s11095-016-2006-1).], Tóthfalusi and Endrényi^[Tóthfalusi L, Endrényi L. *Algorithms for Evaluating Reference Scaled Average Bioequivalence: Power, Bias, and Consumer Risk.* Stat Med. 2017: 36(27); 4378--90. [doi:10.1002/sim.7440](https://doi.org/10.1002/sim.7440).], and Molins *et al.*^[Molins E, Cobo E, Ocaña J. *Two-Stage Designs Versus European Scaled Average Designs in Bioequivalence Studies for Highly Variable Drugs: Which to Choose?* Stat Med. 2017: 36(27); 4378--90. [doi:10.1002/sim.7452](https://doi.org/10.1002/sim.7452).] showed that under certain conditions (EMA, Health Canada: *CV~wR~* \~0.22--0.42, FDA: *CV~wR~* <0.30) the type I error will be inflated.

```{r}
CV      <- 0.35
res     <- data.frame(n = NA, CV = CV, TIE = NA)
res$n   <- sampleN.scABEL(CV = CV, design = "2x2x4", print = FALSE,
                          details = FALSE)[["Sample size"]]
U       <- scABEL(CV = CV)[["upper"]]
res$TIE <- power.scABEL(CV = CV, n = res$n, theta0 = U, design = "2x2x4")
print(res, row.names = FALSE)
```
With \~0.0656 the type I error is inflated (significantly larger than the nominal $\alpha$ 0.05).

![**Fig. 1** Empiric type I error for the EMA’s ABEL, 4-period full replicate design](figure8.png){width=450px}

Various approaches were suggested to control the patient’s risk.

<small>[TOC ↩](#TOC)</small>

## Iteratively adjusted $\alpha$
Based on the observed *CV~wR~*, $\alpha$ is adjusted and the study should be evaluated with a wider confidence interval (Labes and Schütz 2016).
```{r}
CV <- 0.35
n  <- sampleN.scABEL(CV = CV, design = "2x2x4", print = FALSE,
                     details = FALSE)[["Sample size"]]
scABEL.ad(CV = CV, design = "2x2x4", n = n)
```
An adjusted $\alpha$ of 0.0363 (*i.e.*, the 92.74\% CI) controls the patient’s risk. However, a slightly lower power can be expected (0.773 instead of 0.812).

In order to counteract this loss in power, one can estimate the sample size with the function <span style="white-space:nowrap">`sampleN.scABEL.ad()`</span>.
```{r}
CV <- 0.35
sampleN.scABEL.ad(CV = CV, design = "2x2x4")
```
Instead of with 34 subjects the study should be performed with 38 subjects.

<small>[TOC ↩](#TOC)</small>

Since the observed *CV~wR~* is not the true – unknown – one, Molins *et al.* suggested to assume the worst and adjust for *CV~wR~* 0.30 in all cases. Whilst the most conservative approach, it will negatively impact power, esp. for true high variability (say, >0.42).
```{r}
CV <- 0.35
n  <- sampleN.scABEL(CV = CV, design = "2x2x4", print = FALSE,
                     details = FALSE)[["Sample size"]]
scABEL.ad(CV = 0.30, design = "2x2x4", n = n)
```
Whilst the adjusted $\alpha$ of 0.02857 (94.29\% CI) controls the patient’s risk, it leads to an even lower power.

Example with a *CV~wR~* of 0.80, which is far above the region where an inflated type I error can be expected. 4-period full replicate design, 50 subjects.
```{r, echo=FALSE}
CV  <- 0.80
n   <- sampleN.scABEL(CV = CV, design = "2x2x4", print = FALSE,
                      details = FALSE)[["Sample size"]]
res <- data.frame(method = c("Labes and Schütz", "Molins et al."),
                  adjustment = "no", alpha = 0.05, TIE = NA, power = NA,
                  stringsAsFactors = FALSE)
x   <- scABEL.ad(CV = CV, n = n, design = "2x2x4", print = FALSE)
res$TIE[1]   <- x$TIE.unadj
res$power[1] <- x$pwr.unadj
x   <- scABEL.ad(CV = 0.30, n = n, design = "2x2x4", print = FALSE)
res$adjustment[2] <- "yes"
res$alpha[2] <- x$alpha.adj
res$TIE[2]   <- x$TIE.adj
res$power[2] <- power.scABEL(alpha = x$alpha.adj, CV = CV,
                             n = n, design = "2x2x4")
print(res, row.names = FALSE)
```
The loss in power is substantial.

<small>[TOC ↩](#TOC)</small>

## ‘Exact’ Procedure
Proposed by Tóthfalusi and Endrényi^[Tóthfalusi L, Endrényi L. *An Exact Procedure for the Evaluation of Reference-Scaled Average Bioequivalence.* AAPS J. 2016: 18(2); 476--89. [doi:10.1208/s12248-016-9873-6](https://doi.org/10.1208/s12248-016-9873-6).] and improved by the same authors in 2017.
```{r}
CV <- 0.35
n  <- sampleN.scABEL(CV = CV, design = "2x2x4", print = FALSE,
                     details = FALSE)[["Sample size"]]
U  <- scABEL(CV = CV)[["upper"]]
power.RSABE2L.sds(CV = CV, design = "2x2x4", theta0 = U,
                  n = n, nsims = 1e6, progress = FALSE) # patience, please...
```
With \~0.0482 the patient’s risk is controlled. However, the regulatory acceptance is unclear.

<small>[TOC ↩](#TOC)</small>

# Helpers

<h2>Expanded Limits</h2><!-- not in the TOC -->
```{r}
CV  <- c(0.30, 0.40898, 0.50, 0.57382)
res <- data.frame(CV = CV, EMA.L = NA, EMA.U = NA, EMA.cap = "",
                  HC.L = NA, HC.U = NA, HC.cap = "",
                  stringsAsFactors = FALSE)
for (i in seq_along(CV)) {
  res[i, 2:3] <- sprintf("%.4f", scABEL(CV[i], regulator = "EMA"))
  res[i, 5:6] <- sprintf("%.4f", scABEL(CV[i], regulator = "HC"))
}
res$EMA.cap[res$CV <= 0.30]   <- res$HC.cap[res$CV <= 0.30] <- "lower"
res$EMA.cap[res$CV >= 0.50]   <- "upper"
res$HC.cap[res$CV >= 0.57382] <- "upper"
print(res, row.names = FALSE)
```
Both for the EMA and Health Canada the lower cap for scaling is 30\%. Whereas the upper cap for the EMA is at 50\% (expanded limits 69.84--143.19\%), for Health Canada it is at ~57.4\% (expanded limits 50.00--150.00\%).

<small>[TOC ↩](#TOC)</small>

<h2>‘Implied’ Limits</h2><!-- not in the TOC -->
```{r}
CV  <- c(0.30, 0.50, 1.0)
res <- data.frame(CV = CV, L = NA, U = NA, cap = "",
                  stringsAsFactors = FALSE)
for (i in seq_along(CV)) {
  res[i, 2:3] <- sprintf("%.4f", scABEL(CV[i], regulator = "FDA"))
}
res$cap[res$CV <= 0.30] <- "lower"
print(res, row.names = FALSE)
```
For the FDA there is no upper cap (scaling is unlimited).

<small>[TOC ↩](#TOC)</small>

<h2>Regulatory Settings</h2><!-- not in the TOC -->
```{r}
reg <- c("EMA", "HC", "FDA")
for (i in 1:3) {
  print(reg_const(regulator = reg[i]))
  cat("\n")
}
```
<small>[TOC ↩](#TOC)</small>

# Authors{#authors}
|function|author(s)|
|--------|---|
|`sampleN.scABEL`, `sampleN.RSABE`, `sampleN.NTIDFDA`, `sampleN.HVNTID`,<br />`power.scABEL`, `power.RSABE2L.sdsims`, `scABEL`, `reg_const`|Detlew Labes|
|`power.scABEL.sdsims`|<span style="white-space:nowrap">Detlew Labes, Benjamin Lang</span>|
|`sampleN.scABEL.ad`, `sampleN.scABEL.sdsims`,<br />`sampleN.RSABE2L.sdsims`, `scABEL.ad`, `U2CVwR`|Helmut Schütz|

# Man-pages
Man-pages of functions used in examples of this vignette:

  * Sample Size
    * [sampleN.scABEL](library/html/sampleN.scABEL.html)
    * [sampleN.scABEL.sdsims](library/html/sampleN.scABEL.sdsims.html)
    * [sampleN.scABEL.ad](library/html/sampleN.scABEL.ad.html)
    * [sampleN.RSABE](library/html/power.RSABE.html)
    * [sampleN.NTIDFDA](library/html/sampleN.NTIDFDA.html)
    * [sampleN.HVNTID](library/html/sampleN.HVNTID.html)
  * Power
    * [power.scABEL](library/html/power.scABEL.html)
    * [power.RSABE2L.sds](library/html/power.RSABE2L.sds.html)
  * Helpers
    * [scABEL](library/html/scABEL.html)
    * [scABEL.ad](library/html/scABEL.ad.html)
    * [reg_const](library/html/reg_const.html)

[Online manual](https://cran.r-project.org/package=PowerTOST/PowerTOST.pdf "PDF") of all functions.

<small>[TOC ↩](#TOC)</small>

# License{#license}
[GPL-2](https://cran.r-project.org/web/licenses/GPL-2 "GNU General Public License, Version 2") | [GPL-3](https://cran.r-project.org/web/licenses/GPL-3 "GNU General Public License, Version 2")

<small>[TOC ↩](#TOC)</small>